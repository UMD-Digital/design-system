# .github/workflows/auto-release.yml
name: Automated Package Release

# Trigger on push to npm-release branch
on:
  push:
    branches:
      - npm-release

# Prevent concurrent releases
concurrency:
  group: auto-release
  cancel-in-progress: false

permissions:
  contents: write
  packages: write
  pull-requests: write

jobs:
  # Job 1: Detect which packages need releasing
  detect-versions:
    name: Detect Version Changes
    runs-on: ubuntu-latest
    outputs:
      has-releases: ${{ steps.detect.outputs.has-releases }}
      release-count: ${{ steps.detect.outputs.release-count }}
      foundation-packages: ${{ steps.detect.outputs.foundation-packages }}
      core-packages: ${{ steps.detect.outputs.core-packages }}
      primary-packages: ${{ steps.detect.outputs.primary-packages }}
      all-packages: ${{ steps.detect.outputs.all-packages }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Enable Corepack
        run: corepack enable

      - name: Install dependencies
        run: yarn install --immutable

      - name: Make detection script executable
        run: chmod +x scripts/detect-versions.js

      - name: Detect version changes
        id: detect
        run: node scripts/detect-versions.js

      - name: Create detection summary
        run: |
          echo "## üîç Version Detection Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Packages to Release" >> $GITHUB_STEP_SUMMARY
          echo "**Total:** ${{ steps.detect.outputs.release-count }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ steps.detect.outputs.foundation-packages }}" != "" ]]; then
            echo "**Foundation Tier:** ${{ steps.detect.outputs.foundation-packages }}" >> $GITHUB_STEP_SUMMARY
          fi
          if [[ "${{ steps.detect.outputs.core-packages }}" != "" ]]; then
            echo "**Core Tier:** ${{ steps.detect.outputs.core-packages }}" >> $GITHUB_STEP_SUMMARY
          fi
          if [[ "${{ steps.detect.outputs.primary-packages }}" != "" ]]; then
            echo "**Primary Tier:** ${{ steps.detect.outputs.primary-packages }}" >> $GITHUB_STEP_SUMMARY
          fi

  # Job 2: Release foundation tier packages (parallel within tier)
  release-foundation:
    name: Release Foundation Tier
    needs: detect-versions
    if: needs.detect-versions.outputs.foundation-packages != ''
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Make release script executable
        run: chmod +x scripts/trigger-releases.sh

      - name: Trigger foundation releases
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
        run: |
          scripts/trigger-releases.sh \
            "${{ needs.detect-versions.outputs.foundation-packages }}" \
            "Foundation"

  # Job 3: Release core tier packages (after foundation)
  release-core:
    name: Release Core Tier
    needs: [detect-versions, release-foundation]
    if: |
      always() &&
      needs.detect-versions.outputs.core-packages != '' &&
      (needs.release-foundation.result == 'success' || needs.release-foundation.result == 'skipped')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Make release script executable
        run: chmod +x scripts/trigger-releases.sh

      - name: Trigger core releases
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
        run: |
          scripts/trigger-releases.sh \
            "${{ needs.detect-versions.outputs.core-packages }}" \
            "Core"

  # Job 4: Release primary tier packages (after core)
  release-primary:
    name: Release Primary Tier
    needs: [detect-versions, release-core]
    if: |
      always() &&
      needs.detect-versions.outputs.primary-packages != '' &&
      (needs.release-core.result == 'success' || needs.release-core.result == 'skipped')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Make release script executable
        run: chmod +x scripts/trigger-releases.sh

      - name: Trigger primary releases
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
        run: |
          scripts/trigger-releases.sh \
            "${{ needs.detect-versions.outputs.primary-packages }}" \
            "Primary"

  # Job 5: Update version badges for all released packages
  update-badges:
    name: Update Version Badges
    needs: [detect-versions, release-foundation, release-core, release-primary]
    if: |
      always() &&
      needs.detect-versions.outputs.has-releases == 'true' &&
      (needs.release-primary.result == 'success' || needs.release-primary.result == 'skipped') &&
      (needs.release-core.result == 'success' || needs.release-core.result == 'skipped') &&
      (needs.release-foundation.result == 'success' || needs.release-foundation.result == 'skipped')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT_TOKEN }}

      - name: Pull latest changes
        run: |
          git pull origin ${{ github.ref_name }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Enable Corepack
        run: corepack enable

      - name: Install dependencies
        run: yarn install --immutable

      - name: Update all version badges
        run: npm run update-badges

      - name: Commit and push badge updates
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          git add **/README.md
          if ! git diff --cached --quiet; then
            git commit -m "docs: update version badges after automated release [skip ci]"
            git remote set-url origin https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}.git
            git push origin ${{ github.ref_name }}
            echo "‚úÖ Badge updates committed and pushed"
          else
            echo "‚ÑπÔ∏è  No badge changes to commit"
          fi

  # Job 6: Aggregate results and notify
  notify-results:
    name: Notify Release Results
    needs: [detect-versions, release-foundation, release-core, release-primary, update-badges]
    if: always() && needs.detect-versions.outputs.has-releases == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine overall status
        id: status
        run: |
          FOUNDATION_STATUS="${{ needs.release-foundation.result }}"
          CORE_STATUS="${{ needs.release-core.result }}"
          PRIMARY_STATUS="${{ needs.release-primary.result }}"

          # Check if any job failed
          if [[ "$FOUNDATION_STATUS" == "failure" ]] || [[ "$CORE_STATUS" == "failure" ]] || [[ "$PRIMARY_STATUS" == "failure" ]]; then
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "message=One or more package releases failed. Check workflow logs for details." >> $GITHUB_OUTPUT
          else
            echo "status=success" >> $GITHUB_OUTPUT
            echo "message=All package releases completed successfully!" >> $GITHUB_OUTPUT
          fi

      - name: Create release summary
        run: |
          echo "## üöÄ Automated Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ steps.status.outputs.status == 'success' && '‚úÖ Success' || '‚ùå Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Released Packages" >> $GITHUB_STEP_SUMMARY
          echo "**Total:** ${{ needs.detect-versions.outputs.release-count }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Foundation Tier:** ${{ needs.detect-versions.outputs.foundation-packages || 'none' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Core Tier:** ${{ needs.detect-versions.outputs.core-packages || 'none' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Primary Tier:** ${{ needs.detect-versions.outputs.primary-packages || 'none' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Job Results" >> $GITHUB_STEP_SUMMARY
          echo "- Foundation: ${{ needs.release-foundation.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Core: ${{ needs.release-core.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Primary: ${{ needs.release-primary.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üîó [View on NPM](https://www.npmjs.com/org/universityofmaryland)" >> $GITHUB_STEP_SUMMARY
          echo "üîó [View Releases](https://github.com/${{ github.repository }}/releases)" >> $GITHUB_STEP_SUMMARY
          echo "üìù [View Badge Updates](https://github.com/${{ github.repository }}/commit/${{ needs.update-badges.result == 'success' && github.sha || 'latest' }})" >> $GITHUB_STEP_SUMMARY

      - name: Send Slack notification
        uses: slackapi/slack-github-action@v1.25.0
        with:
          payload: |
            {
              "text": "${{ steps.status.outputs.status == 'success' && '‚úÖ' || '‚ùå' }} Automated Release ${{ steps.status.outputs.status == 'success' && 'Successful' || 'Failed' }}",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "${{ steps.status.outputs.status == 'success' && '‚úÖ Automated Release Success' || '‚ùå Automated Release Failed' }}",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Branch:*\n`${{ github.ref_name }}`"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Triggered by:*\n@${{ github.actor }}"
                    }
                  ]
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Packages Released:*\n```${{ needs.detect-versions.outputs.all-packages }}```"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Total Count:*\n${{ needs.detect-versions.outputs.release-count }}"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Message:*\n${{ steps.status.outputs.message }}"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "üì¶ <https://www.npmjs.com/org/universityofmaryland|View on NPM> | üì∞ <${{ github.server_url }}/${{ github.repository }}/releases|View Releases> | üîç <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow>"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

  # Job 7: Handle no releases case
  no-releases:
    name: No Releases Needed
    needs: detect-versions
    if: needs.detect-versions.outputs.has-releases != 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Log no releases
        run: |
          echo "‚ÑπÔ∏è  No packages need releasing at this time."
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ‚ÑπÔ∏è  No Releases Needed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All package versions in \`${{ github.ref_name }}\` match or are behind the published NPM versions." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "To release packages:" >> $GITHUB_STEP_SUMMARY
          echo "1. Update version in package.json (use \`npm version\` or manual edit)" >> $GITHUB_STEP_SUMMARY
          echo "2. Commit and push to the release branch" >> $GITHUB_STEP_SUMMARY
          echo "3. This workflow will automatically detect and publish the new version" >> $GITHUB_STEP_SUMMARY
