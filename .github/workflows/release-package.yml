# .github/workflows/release-package.yml
name: Release Specific Package

on:
  workflow_dispatch:
    inputs:
      package:
        description: 'Package to release'
        required: true
        type: choice
        options:
          - components
          - elements
          - feeds
          - styles
          - utilities
          - builder
          - model
          - icons
          - tokens

      version_bump:
        description: 'Version bump type'
        required: false
        type: choice
        options:
          - patch
          - minor
          - major
          - prerelease
        default: 'patch'
      preid:
        description: 'Pre-release identifier (alpha, beta, rc)'
        required: false
        type: string
        default: ''
      dry_run:
        description: 'Dry run (no publish)'
        required: false
        type: boolean
        default: false
      auto_detect_version:
        description: 'Auto-detect version from package.json (skips versioning step)'
        required: false
        type: boolean
        default: false

  workflow_call:
    inputs:
      package:
        description: 'Package to release'
        required: true
        type: string
      version_bump:
        description: 'Version bump type'
        required: false
        type: string
        default: 'patch'
      preid:
        description: 'Pre-release identifier (alpha, beta, rc)'
        required: false
        type: string
        default: ''
      dry_run:
        description: 'Dry run (no publish)'
        required: false
        type: boolean
        default: false
      auto_detect_version:
        description: 'Auto-detect version from package.json (skips versioning step)'
        required: false
        type: boolean
        default: false
    outputs:
      package_version:
        description: 'Version of the released package'
        value: ${{ jobs.release-package.outputs.package_version }}
      success:
        description: 'Whether the release succeeded'
        value: ${{ jobs.release-package.outputs.success }}

permissions:
  contents: write
  packages: write
  pull-requests: write

jobs:
  release-package:
    name: Release ${{ inputs.package }}
    runs-on: ubuntu-latest
    outputs:
      package_version: ${{ steps.package_version.outputs.version }}
      success: ${{ steps.release_status.outputs.success }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'yarn'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Build dependencies first
        run: |
          echo "Building dependencies for ${{ inputs.package }}..."

          # Build based on package dependencies
          case "${{ inputs.package }}" in
            "icons"|"tokens")
              echo "No dependencies to build"
              ;;
            "styles")
              npx lerna run build --scope=@universityofmaryland/web-token-library
              ;;
            "utilities")
              npx lerna run build --scope=@universityofmaryland/web-token-library
              npx lerna run build --scope=@universityofmaryland/web-styles-library
              ;;
            "builder"|"model")
              npx lerna run build --scope=@universityofmaryland/web-token-library
              ;;
            "elements")
              npx lerna run build --scope=@universityofmaryland/web-icons-library
              npx lerna run build --scope=@universityofmaryland/web-token-library
              npx lerna run build --scope=@universityofmaryland/web-styles-library
              npx lerna run build --scope=@universityofmaryland/web-utilities-library
              npx lerna run build --scope=@universityofmaryland/web-builder-library
              ;;
            "feeds")
              npx lerna run build --scope=@universityofmaryland/web-icons-library
              npx lerna run build --scope=@universityofmaryland/web-token-library
              npx lerna run build --scope=@universityofmaryland/web-styles-library
              npx lerna run build --scope=@universityofmaryland/web-utilities-library
              npx lerna run build --scope=@universityofmaryland/web-builder-library
              npx lerna run build --scope=@universityofmaryland/web-elements-library
              ;;
            "components")
              echo "Building all dependencies..."
              npx lerna run build --stream --scope=@universityofmaryland/web-icons-library
              npx lerna run build --stream --scope=@universityofmaryland/web-token-library
              npx lerna run build --stream --scope=@universityofmaryland/web-styles-library
              npx lerna run build --stream --scope=@universityofmaryland/web-utilities-library
              npx lerna run build --stream --scope=@universityofmaryland/web-builder-library
              npx lerna run build --stream --scope=@universityofmaryland/web-model-library
              npx lerna run build --stream --scope=@universityofmaryland/web-elements-library
              npx lerna run build --stream --scope=@universityofmaryland/web-feeds-library
              ;;
          esac

      - name: Build package
        run: npx lerna run build --scope=@universityofmaryland/web-${{ inputs.package }}-library

      - name: Run tests for package
        run: npx lerna run test --scope=@universityofmaryland/web-${{ inputs.package }}-library

      - name: Update version badges
        if: ${{ inputs.dry_run != true && inputs.auto_detect_version != true }}
        run: npm run update-badges -- --package=${{ inputs.package }}

      - name: Detect current version (auto-detect mode)
        if: ${{ inputs.auto_detect_version == true }}
        id: current_version
        run: |
          CURRENT_VERSION=$(node -p "require('./packages/${{ inputs.package }}/package.json').version")
          echo "Current version in package.json: $CURRENT_VERSION"
          echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT

          # Determine if it's a pre-release
          if [[ "$CURRENT_VERSION" == *"-"* ]]; then
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
            # Extract preid (alpha, beta, rc, etc.)
            PREID=$(echo "$CURRENT_VERSION" | sed -n 's/.*-\([a-z]*\)\..*/\1/p')
            echo "preid=$PREID" >> $GITHUB_OUTPUT
          else
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
            echo "preid=" >> $GITHUB_OUTPUT
          fi

      - name: Version package (pre-release)
        if: ${{ contains(inputs.version_bump, 'pre') && inputs.dry_run != true && inputs.auto_detect_version != true }}
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          cd packages/${{ inputs.package }}
          npm version ${{ inputs.version_bump }} --preid=${{ inputs.preid }} --no-git-tag-version
          cd ../..
          git add packages/${{ inputs.package }}/package.json
          NEW_VERSION=$(node -p "require('./packages/${{ inputs.package }}/package.json').version")
          TAG_NAME="@universityofmaryland/web-${{ inputs.package }}-library@${NEW_VERSION}"

          # Check if tag already exists
          if git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
            echo "âŒ Error: Tag $TAG_NAME already exists locally"
            exit 1
          fi

          if git ls-remote --tags origin | grep -q "refs/tags/$TAG_NAME$"; then
            echo "âŒ Error: Tag $TAG_NAME already exists on remote"
            echo "This version has already been released. Use a different version bump."
            exit 1
          fi

          git commit -m "chore(release): $TAG_NAME"
          git tag "$TAG_NAME"
          gh release create "$TAG_NAME" --generate-notes

      - name: Version package (standard release)
        if: ${{ !contains(inputs.version_bump, 'pre') && inputs.dry_run != true && inputs.auto_detect_version != true }}
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          cd packages/${{ inputs.package }}
          npm version ${{ inputs.version_bump }} --no-git-tag-version
          cd ../..
          git add packages/${{ inputs.package }}/package.json
          NEW_VERSION=$(node -p "require('./packages/${{ inputs.package }}/package.json').version")
          TAG_NAME="@universityofmaryland/web-${{ inputs.package }}-library@${NEW_VERSION}"

          # Check if tag already exists
          if git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
            echo "âŒ Error: Tag $TAG_NAME already exists locally"
            exit 1
          fi

          if git ls-remote --tags origin | grep -q "refs/tags/$TAG_NAME$"; then
            echo "âŒ Error: Tag $TAG_NAME already exists on remote"
            echo "This version has already been released. Use a different version bump."
            exit 1
          fi

          git commit -m "chore(release): $TAG_NAME"
          git tag "$TAG_NAME"
          gh release create "$TAG_NAME" --generate-notes

      - name: Create GitHub release (auto-detect mode)
        if: ${{ inputs.auto_detect_version == true && inputs.dry_run != true }}
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          NEW_VERSION="${{ steps.current_version.outputs.version }}"
          TAG_NAME="@universityofmaryland/web-${{ inputs.package }}-library@${NEW_VERSION}"

          # Check if tag already exists
          if git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
            echo "âš ï¸  Tag $TAG_NAME already exists locally, skipping tag creation"
          elif git ls-remote --tags origin | grep -q "refs/tags/$TAG_NAME$"; then
            echo "âš ï¸  Tag $TAG_NAME already exists on remote, skipping tag creation"
          else
            echo "Creating tag $TAG_NAME"
            git tag "$TAG_NAME"
            gh release create "$TAG_NAME" --generate-notes
          fi

      - name: Publish to NPM (dry-run)
        if: ${{ inputs.dry_run == true }}
        run: |
          echo "Dry run enabled - skipping NPM publish"
          echo "//registry.npmjs.org/:_authToken=${NODE_AUTH_TOKEN}" > .npmrc
          npm publish --dry-run ./packages/${{ inputs.package }}
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish to NPM
        if: ${{ inputs.dry_run != true }}
        run: |
          echo "//registry.npmjs.org/:_authToken=${NODE_AUTH_TOKEN}" > .npmrc

          # Determine dist-tag
          if [[ "${{ inputs.auto_detect_version }}" == "true" ]]; then
            # Auto-detect mode: check if version is pre-release
            if [[ "${{ steps.current_version.outputs.is_prerelease }}" == "true" ]]; then
              DIST_TAG="${{ steps.current_version.outputs.preid }}"
            else
              DIST_TAG="latest"
            fi
          else
            # Manual mode: use version_bump to determine tag
            DIST_TAG="${{ contains(inputs.version_bump, 'pre') && inputs.preid || 'latest' }}"
          fi

          echo "Publishing with dist-tag: $DIST_TAG"
          npm publish ./packages/${{ inputs.package }} --tag "$DIST_TAG"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Push changes
        if: ${{ inputs.dry_run != true }}
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          git remote set-url origin https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}.git
          git push --follow-tags origin ${{ github.ref_name }}

      - name: Get package version
        id: package_version
        run: |
          VERSION=$(node -p "require('./packages/${{ inputs.package }}/package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Set release status
        id: release_status
        if: always()
        run: |
          if [[ "${{ job.status }}" == "success" ]]; then
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "success=false" >> $GITHUB_OUTPUT
          fi

      - name: Summary
        run: |
          echo "## Package Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Package:** @universityofmaryland/web-${{ inputs.package }}-library" >> $GITHUB_STEP_SUMMARY
          echo "**New Version:** ${{ steps.package_version.outputs.version }}" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ inputs.auto_detect_version }}" == "true" ]]; then
            echo "**Mode:** Auto-detected from package.json" >> $GITHUB_STEP_SUMMARY
            if [[ "${{ steps.current_version.outputs.is_prerelease }}" == "true" ]]; then
              echo "**Release Type:** Pre-release (${{ steps.current_version.outputs.preid }})" >> $GITHUB_STEP_SUMMARY
            else
              echo "**Release Type:** Stable" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "**Version Bump:** ${{ inputs.version_bump }}" >> $GITHUB_STEP_SUMMARY
            if [[ "${{ inputs.version_bump }}" == *"pre"* ]]; then
              echo "**Pre-release ID:** ${{ inputs.preid }}" >> $GITHUB_STEP_SUMMARY
            fi
          fi

          echo "**Dry Run:** ${{ inputs.dry_run }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— [View on NPM](https://www.npmjs.com/package/@universityofmaryland/web-${{ inputs.package }}-library)" >> $GITHUB_STEP_SUMMARY

  notify:
    name: Send Notifications
    needs: release-package
    if: always()
    uses: ./.github/workflows/release-notification.yml
    with:
      status: ${{ needs.release-package.result == 'success' && 'success' || 'failure' }}
      version_bump: ${{ inputs.version_bump }}
      packages_changed: '@universityofmaryland/web-${{ inputs.package }}-library'
      package_version: ${{ needs.release-package.outputs.package_version }}
      error_message: ${{ needs.release-package.result == 'failure' && 'Package release failed. Check workflow logs.' || '' }}
    secrets:
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
